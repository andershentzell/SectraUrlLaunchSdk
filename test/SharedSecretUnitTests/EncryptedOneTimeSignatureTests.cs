using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Xunit;

namespace Sectra.UrlLaunch.SharedSecret;
public class EncryptedOneTimeSignatureTests {

    private const string Rsa2048Cert =
@"MIIDADCCAeigAwIBAgIQaRtwaRDmlpFEpka5e/Wa+TANBgkqhkiG9w0BAQsFADATMREwDwYDVQQDDAhUZXN0IFJTQTAeFw0yMjA1MzEwODI1NTJaFw0yMzA1MzEwODQ1NTJaMBMxETAPBgNVBAMMCFRlc3QgUlNBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxFVQHbI2lHGVUZehtiLKCeII3mKyoGDUUmAOegYKquL2ME6u0k4xEHgDTyorQ/xm+QhCCh23OE5ltzcc3yxczFSQ3rK9Y7goa5ebWeTnArxvZxkrdbMG+I2aPoahPG7kUVPjq/SInzfLf71I+mH0YdOgo87zk4Br9GBzbYu26Xgk5H4ZP+nCdAT/VSPON0nZriEWKhUolaxzoZDoyM6/chzwbMTiO9BBDZB+quXKk7DLHUJAo6LCxdB77N/Hj2J+HKZWMdGlO+qL4+rdp3NL2/C4l93XVijCtKc0cP41Em50HcdhxyP5YZ5OpjcSOaKkX60Fu5SXV2T+t30gBE2/nQIDAQABo1AwTjAOBgNVHQ8BAf8EBAMCB4AwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMB0GA1UdDgQWBBSuyq7GWL55fq0n6sMkvGGa+7YQlzANBgkqhkiG9w0BAQsFAAOCAQEAPU87c5izmKGcjIumH0kNxPZaSwkHrNQ8I+WTPdaCFs+Iz9D+/D/YlQZQTEkudgGz+hNy4VFFqCJTf76nrxpeXzbJIfmlUgsJMsBi3bpuVT40IWTkstKn1pmL81vP3c13gOegZbWzfB5/fkaquyCFqX7MM1v0iMUutnUrRyo4pyuS9uzjlzr72ZL1EwUG8aR1E6WB3usTNY5xXwADNyQ5sFFuVbC6IoqCdqk284x2emOC4Acokjv4EqluRG+RIppl4CB9i/rQBTcMm34Joe3ah69pGQDpHhXDPGkL4mHkRqAzfZyct5G4L4l5f7QAbaGCKddwpkeadxkDpUTI
t94yUg==";

    private const string Rsa2048CertWithPrivateKey =
@"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";


    private const string EcdsaP256Cert =
@"MIIBdzCCAR6gAwIBAgIQE8QDmIvTkI5G5HnoEq/+KjAKBggqhkjOPQQDAjAVMRMwEQYDVQQDDApUZXN0IEVDRFNBMB4XDTIyMDUzMTA4NDcxN1oXDTIzMDUzMTA5MDcxN1owFTETMBEGA1UEAwwKVGVzdCBFQ0RTQTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABLPWqz3XqEiOn/KMsgl72vjHpNBzyJMAYS3ZEH/0HK4dfY6G4RwtXsd6MpplBwfaVXq8T2eOGIyruPn3FNSvEXejUDBOMA4GA1UdDwEB/wQEAwIHgDAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwHQYDVR0OBBYEFOaAxBVSfuOS4kzU8KqCMqxG/zhhMAoGCCqGSM49BAMCA0cAMEQCIDShoNniue6s1S+y/QFM719LkUul0h7YsYmnjTLHSYssAiB3TUYSSf6k0bJ/BgMAjSziXqHGdBjWic7ZiFxAYt3A3A==";


    private const string EcdsaP256CertWithPrivateKey =
@"MIIEPwIBAzCCA/sGCSqGSIb3DQEHAaCCA+wEggPoMIID5DCCAc0GCSqGSIb3DQEHAaCCAb4EggG6MIIBtjCCAbIGCyqGSIb3DQEMCgECoIHMMIHJMBwGCiqGSIb3DQEMAQMwDgQIxNMK5I8RWNUCAgfQBIGozK1sgzdv8N6qusZJYzXSyBwbkEY0MC3qget2id906IF/iXSFfs7+o1B4tJIPRvz0GylLRp7B+3tvFmm8dgUIVNtqf027zzfh0PD4ttTX1VGx4jeQZMp5wQzOYsE9XrEzN8Oseyua9AoS7S0xzZVaPd60yTO0wIG+477FM+4PVHTO6foQTSUiNMEbhiIcfh0jxBjN8Z/UlgErN65xVM9CgJg1+tEWdABrMYHTMBMGCSqGSIb3DQEJFTEGBAQBAAAAMF0GCSqGSIb3DQEJFDFQHk4AdABlAC0ANQA5ADkAZgA3ADkANABmAC0AZgAxAGIAMwAtADQAMwA2ADQALQBiAGUAYQA3AC0AMgBlADkAYgA5AGYAMwAwADIAMgBlADMwXQYJKwYBBAGCNxEBMVAeTgBNAGkAYwByAG8AcwBvAGYAdAAgAFMAbwBmAHQAdwBhAHIAZQAgAEsAZQB5ACAAUwB0AG8AcgBhAGcAZQAgAFAAcgBvAHYAaQBkAGUAcjCCAg8GCSqGSIb3DQEHBqCCAgAwggH8AgEAMIIB9QYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQIX2oVzN/E1kUCAgfQgIIByFDoni6r+x5SPrIR91d0h94hjNXbo2pLFIDBPewbyLmM4qxo1efvc2Tm5/yfLEXaKlxMMX8kTsEtas6uxe4CGgJKroNKfltzJOlHc3LTQz7lMw5DvrLYBPp6g1sql169p9nzoPwwG1CHkIin4ExCPe/r9KNx7F59hhMufO09h4HM+L2zbU6KeAg8WIqRSyE5BHGUFdz4+7vCyC9i2WtbnLkZognwD8Rn3e+e5NncGN+nfyUVOUkUrjllRuU/Ce5A+MBI
vSOxu7gqNsseRYQzQhHMk/nNJ5H0bSh/PkRHX8LoBr0655yX9siYyfpQ7bDzgVl+O6VsAh+m6s+zt3Vt+HKw2tElV9nAOy0EG0afnRfVCoYxWEEp4Bjtmapo1WgIlPU2oEuCwyJA4FAJXCrVFJaL84vWoaXw9bLodWzL+ZGHhjrwFYG1aLm/Z4iN6KPP9sEUtHML8mIT06m3GfAMPhlQQFwlPe5gbZdmqA42uE8rQySw7JdeTic+/gvFNPLcyOB3qAbc1cG/JzlfCX+VfPBKnNZoLz2nH5j3BpPG5hWmnrF2Kqct85q8ngWElOkXqNlubhpbPjTjhBDtu1wEyrfMMYSRD0Kz8TA7MB8wBwYFKw4DAhoEFKdO8oFz/KGD1ihvn8eRwRqglC+tBBRL0bZk+Q6ORAh6pUoG/0iDverCBwICB9A=";


    public class EncryptedOneTimeSignatureTestData : IEnumerable<object[]> {
        public IEnumerator<object[]> GetEnumerator() {
            yield return new object[] { Rsa2048Cert, Rsa2048CertWithPrivateKey };
            yield return new object[] { EcdsaP256Cert, EcdsaP256CertWithPrivateKey };
        }
        IEnumerator IEnumerable.GetEnumerator() => GetEnumerator();
    }

    private static string plainTextTestData = "The quick brown fox jumps over the lazy dog";


    [Fact]
    public void EncryptedOneTimeSignature_SignUsingHmacAndVerify_Succeeds() {
        var key = SymmetricEncryption.GenerateKey();
        var signedCipherText = EncryptedOneTimeSignature.EncryptAndSign(
            Encoding.UTF8.GetBytes(plainTextTestData), key);

        var plainText = EncryptedOneTimeSignature.VerifyAndDecrypt(signedCipherText.ToArray(), key).ToArray();

        Assert.Equal(plainTextTestData, Encoding.UTF8.GetString(plainText));
    }

    [Fact]
    public void EncryptedOneTimeSignature_SignStringUsingHmacAndVerify_Succeeds() {
        var key = SymmetricEncryption.GenerateKey();
        var signedCipherText = EncryptedOneTimeSignature.EncryptAndSign(plainTextTestData, key);

        var plainText = EncryptedOneTimeSignature.VerifyAndDecrypt(signedCipherText, key);
        Assert.Equal(plainTextTestData, plainText);
    }
}

